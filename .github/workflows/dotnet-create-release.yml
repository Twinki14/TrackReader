name: .NET Core - Create release
on:
  workflow_dispatch:
    
jobs:
  build:
    strategy:
      matrix:
        targetPlatform: [x86, x64]

    env:
      AppProjFile: src/TrackReader/TrackReader.csproj
      Configuration: Release

    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2
      
    - name: Set version
      uses: aarnott/nbgv@v0.3
      with:
        setAllVars: true

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 5.0.x
 
    - name: Restore
      run: dotnet restore --runtime=$env:RuntimeIdentifier
      env:
        RuntimeIdentifier: win-${{ matrix.targetplatform }}
      
    - name: Build
      run: dotnet build $env:AppProjFile --configuration=$env:Configuration --runtime=$env:RuntimeIdentifier --no-restore
      env:
        RuntimeIdentifier: win-${{ matrix.targetplatform }}
      
    # - name: Test
      # run: dotnet test --no-restore --verbosity normal

    - name: Publish
      run: dotnet publish $env:AppProjFile --configuration=$env:Configuration --runtime=$env:RuntimeIdentifier /p:PublishProfile=FolderProfile --no-restore
      env:
        RuntimeIdentifier: win-${{ matrix.targetplatform }}

    - uses: actions/upload-artifact@v2
      with:
        name: TrackReader${{ matrix.targetplatform }}.exe
        path: src/TrackReader/bin/Release/net5.0-windows/win-${{ matrix.targetplatform }}/publish/TrackReader.exe

  release:
      needs: build

      steps:
          - name: Set version
            uses: aarnott/nbgv@v0.3
            with:
              setAllVars: true
